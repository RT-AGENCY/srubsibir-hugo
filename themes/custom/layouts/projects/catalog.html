{{ define "main" }}
<div class="projects-catalog">
  <div class="container">

    <!-- Хлебные крошки -->
    <nav class="breadcrumb">
      <ul class="breadcrumb-list">
        <li class="breadcrumb-item"><a href="/">Главная</a></li>
        <li class="breadcrumb-item"><span>Проекты</span></li>
      </ul>
    </nav>

    <!-- Заголовок -->
    <h1 class="catalog-title">{{ .Title | default "Каталог проектов" }}</h1>
    <button id="mobile-filters-toggle" class="mobile-filters-toggle">
      Показать фильтры
    </button>

    <!-- Фильтры -->
    <div class="filters-section">
      <div class="filters-container">

        <!-- Тип строения -->
        <div class="filter-group">
          <label for="category-filter">Тип строения:</label>
          <select id="category-filter" class="filter-select">
            <option value="">Все</option>
            <option value="Дом">Дома</option>
            <option value="Баня">Бани</option>
            <option value="Дом-баня">Дома-бани</option>
            <option value="Беседка">Беседки</option>
          </select>
        </div>

        <!-- Площадь -->
        <div class="filter-group">
          <label for="area-filter">Площадь:</label>
          <select id="area-filter" class="filter-select">
            <option value="">Любая</option>
            <option value="0-50">До 50 м²</option>
            <option value="50-100">50-100 м²</option>
            <option value="100-150">100-150 м²</option>
            <option value="150-200">150-200 м²</option>
            <option value="200-99999">Свыше 200 м²</option>
          </select>
        </div>

        <!-- Материал -->
        <div class="filter-group">
          <label for="material-filter">Материал:</label>
          <select id="material-filter" class="filter-select">
            <option value="">Любой</option>
            <option value="кедр">Кедр</option>
            <option value="лиственница">Лиственница</option>
            <option value="сосна">Сосна</option>
          </select>
        </div>

        <!-- Этажность -->
        <div class="filter-group">
          <label for="floors-filter">Этажей:</label>
          <select id="floors-filter" class="filter-select">
            <option value="">Любое</option>
            <option value="1">1 этаж</option>
            <option value="2">2 этажа</option>
            <!-- <option value="2.5">2.5 этажа</option> -->
          </select>
        </div>

        <!-- Цена -->
        <div class="filter-group">
          <label for="price-filter">Цена:</label>
          <select id="price-filter" class="filter-select">
            <option value="">Любая</option>
            <option value="0-2000000">До 2 млн</option>
            <option value="2000000-4000000">2-4 млн</option>
            <option value="4000000-6000000">4-6 млн</option>
            <option value="6000000-99999999">Свыше 6 млн</option>
          </select>
        </div>

        <!-- Поиск -->
        <div class="filter-group search-group">
          <label for="search-filter">Поиск:</label>
          <input type="text" id="search-filter" class="filter-input" placeholder="Название проекта...">
        </div>

        <!-- Сортировка -->
        <div class="filter-group">
          <label for="sort-filter">Сортировка:</label>
          <select id="sort-filter" class="filter-select">
            <option value="">По умолчанию</option>
            <option value="price-asc">Цена: по возрастанию</option>
            <option value="price-desc">Цена: по убыванию</option>
            <option value="area-asc">Площадь: по возрастанию</option>
            <option value="area-desc">Площадь: по убыванию</option>
            <option value="title-asc">Название: А-Я</option>
            <option value="title-desc">Название: Я-А</option>
            <option value="date-desc">Сначала новые</option>
            <option value="date-asc">Сначала старые</option>
          </select>
        </div>

        <!-- Кнопка сброса -->
        <button id="reset-filters" class="reset-btn">Сбросить фильтры</button>

        <!-- Кнопка поделиться фильтрами -->
        <button id="share-filters" class="share-btn">Поделиться ссылкой</button>
      </div>
    </div>
    <!-- Лоадер -->
    <div id="catalog-loader" class="catalog-loader">
      <div class="loader-spinner"></div>
      <p class="loader-text">Загрузка проектов...</p>
    </div>

    <!-- Результаты поиска -->
    <div class="results-info">
      <span id="results-count">{{ len .Pages }}</span>
      {{ if eq (len .Pages) 1 }}проект{{ else if and (ge (len .Pages) 2) (le (len .Pages) 4) }}проекта{{ else
      }}проектов{{ end }}
    </div>

    <!-- Сетка проектов -->
  <div class="projects-grid" id="projects-grid">
      {{ range .Pages }}
      {{ if .Params.category }}
      <div class="project-card"
        data-category='{{ if .Params.categories }}{{ delimit .Params.categories "," }}{{ else }}{{ .Params.main_category | default .Params.category }}{{ end }}'
        data-area="{{ .Params.area | replaceRE `[^0-9]` `` }}" data-floors="{{ .Params.floors }}"
        data-material='{{ .Params.material | default "" }}'
        data-price="{{ .Params.price | replaceRE `[^0-9]` `` }}" data-material="{{ .Content | lower }}"
        data-title="{{ .Title | lower }}" data-date="{{ .Date.Unix }}">

        <div class="project-image">
          {{ if .Params.gallery }}
          {{ $firstImage := index .Params.gallery 0 }}
          <img src="{{ $firstImage }}" alt="{{ .Title }}" loading="lazy">
          {{ else }}
          <img src="/images/placeholder-project.jpg" alt="{{ .Title }}" loading="lazy">
          {{ end }}

          <!-- Бейдж категории -->
          <div class="project-badge">{{ .Params.category }}</div>

          <!-- Цена в углу -->
          {{ if .Params.price }}
          <div class="project-price">{{ .Params.price }}</div>
          {{ end }}
        </div>

        <div class="project-content">
          <h3 class="project-title">
            <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          </h3>

          <div class="project-specs">
            {{ if .Params.area }}
            <span class="spec-item">
              {{ .Params.area }}
            </span>
            {{ end }}

            {{ if .Params.dimensions }}
            <span class="spec-item">
              {{ .Params.dimensions }}
            </span>
            {{ end }}

            {{ if .Params.floors }}
            <span class="spec-item">
              {{ .Params.floors }} {{ if eq .Params.floors 1 }}этаж{{ else }}этажа{{ end }}
            </span>
            {{ end }}
          </div>

          {{ if .Params.description }}
          <p class="project-description">{{ .Params.description | truncate 120 }}</p>
          {{ end }}

          <div class="project-actions">
            <a href="{{ .RelPermalink }}" class="btn-secondary">Подробнее</a>
            <button class="btn-secondary callback-btn" data-project-title="{{ .Title }}"
              data-project-area="{{ .Params.area }}" data-project-price="{{ .Params.price }}"
              data-project-category="{{ .Params.main_category | default .Params.category }}">
              Узнать цену
            </button>
          </div>
        </div>
      </div>
      {{ end }}
      {{ end }}
    </div>

    <!-- Сообщение "ничего не найдено" -->
    <div id="no-results" class="no-results" style="display: none;">
      <h3>Ничего не найдено</h3>
      <p>Попробуйте изменить параметры поиска или <button id="reset-from-empty" class="link-btn">сбросить все
          фильтры</button></p>
    </div>

  </div>
</div>

<style>
  .projects-catalog {
    padding: 20px 0 60px;
    min-height: 70vh;
  }

  /* Хлебные крошки */
  .breadcrumb {
    margin-bottom: 20px;
  }

  .breadcrumb-list {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0;
    gap: 5px;
    font-size: 14px;
  }

  .breadcrumb-item a {
    color: #666;
    text-decoration: none;
  }

  .breadcrumb-item a:hover {
    color: #2c5530;
  }

  .breadcrumb-item:not(:last-child)::after {
    content: " › ";
    margin-left: 5px;
    color: #999;
  }

  /* Заголовок */
  .catalog-title {
    font-size: 2.5rem;
    color: #2c5530;
    margin-bottom: 40px;
    font-weight: 700;
    text-transform: uppercase;
    text-align: center;
  }

  /* Кнопка фильтров для мобильных устройств */
  .mobile-filters-toggle {
    display: none;
    width: 100%;
    background: #444;
    color: white;
    border: none;
    padding: 12px 20px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
    margin-bottom: 16px;
    position: relative;
  }

  .mobile-filters-toggle:hover {
    background: #333;
  }

  .mobile-filters-toggle::after {
    content: '';
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid white;
    transition: transform 0.2s ease;
  }

  .mobile-filters-toggle.active::after {
    transform: translateY(-50%) rotate(180deg);
  }

  /* Обновленные стили фильтров */
  .filters-section {
    background: #fafafa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
    border: 1px solid #d0d0d0;
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.3s ease;
  }

  .filters-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    align-items: end;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .filter-group label {
    display: flex;
    align-items: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 17px;
    font-weight: 500;
    color: #444;
    height: 38px;
    user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-user-select: none;
  }

  .filter-select,
  .filter-input {
    padding: 10px 12px;
    border: 1px solid #d0d0d0;
    border-radius: 0;
    font-size: 14px;
    line-height: 20px;
    height: 42px;
    transition: all 0.2s ease;
    background: white;
    box-sizing: border-box;
    color: #444;
    font-family: inherit;
  }

  .filter-select:focus,
  .filter-input:focus {
    outline: none;
    border-color: #999;
    background: #fafafa;
  }

  .filter-input::placeholder {
    color: #999;
    font-size: 14px;
    font-weight: normal;
  }

  .filter-select {
    cursor: pointer;
    background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='1.5'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 14px;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    padding-right: 35px;
  }

  .search-group {
    grid-column: span 2;
  }

  .reset-btn {
    background: #666;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 0;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    height: fit-content;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
  }

  .reset-btn:hover {
    background: #555;
  }

  /* Мобильные стили */
  @media (max-width: 768px) {

    /* Показываем кнопку фильтров */
    .mobile-filters-toggle {
      display: block;
    }

    /* Скрываем секцию фильтров по умолчанию */
    .filters-section {
      max-height: 0;
      opacity: 0;
      padding: 0 20px;
      margin-bottom: 16px;
      border: none;
      background: transparent;
    }

    /* Показываем секцию фильтров при активации */
    .filters-section.active {
      max-height: 1000px;
      /* Достаточно большое значение */
      opacity: 1;
      padding: 20px;
      background: #fafafa;
      border: 1px solid #d0d0d0;
    }

    .filters-container {
      grid-template-columns: 1fr;
    }

    .search-group {
      grid-column: span 1;
    }

    /* Компактные лейблы на мобильных */
    .filter-group label {
      font-size: 16px;
      height: auto;
      min-height: 32px;
      margin-bottom: 4px;
    }
  }

  @media (max-width: 480px) {
    .mobile-filters-toggle {
      font-size: 14px;
      padding: 10px 16px;
    }

    .filters-section.active {
      padding: 16px;
    }

    .filter-group label {
      font-size: 15px;
    }
  }

  /* Результаты */
  .results-info {
    margin-bottom: 20px;
    font-weight: 600;
    color: #666;
  }

  /* Сетка проектов */
  .projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
  }

  .project-card {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    position: relative;
    display: flex;
    flex-direction: column;
    opacity: 1;
    visibility: visible;
    transform: scale(1);
  }

  .project-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
  }

  .project-image {
    position: relative;
    height: 250px;
    overflow: hidden;
  }

  .project-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .project-card:hover .project-image img {
    transform: scale(1.05);
  }

  .project-badge {
    position: absolute;
    top: 15px;
    left: 15px;
    background: rgba(44, 85, 48, 0.9);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .project-price {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(139, 195, 74, 0.95);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-weight: 700;
    font-size: 11px;
  }

  .project-content {
    padding: 25px;
    display: flex;
    flex: 1;
    flex-direction: column;
  }

  .project-title {
    margin: 0 0 15px 0;
    font-size: 1.3rem;
    font-weight: 700;
    min-height: 50px;
  }

  .project-title a {
    color: #2c5530;
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .project-title a:hover {
    color: #8bc34a;
  }

  .project-specs {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 15px;
  }

  .spec-item {
    padding: 6px 12px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }

  .project-description {
    color: #666;
    line-height: 1.5;
    margin-bottom: 20px;
    font-size: 14px;
    flex: 1;
  }

  .project-actions {
    display: flex;
    gap: 12px;
  }

  .btn-primary,
  .btn-secondary {
    padding: 10px 20px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
    text-decoration: none;
    text-align: center;
    flex: 1;
  }

  .btn-primary {
    background: #2c5530;
    color: white;
  }

  .btn-primary:hover {
    background: #1e3a21;
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: transparent;
    color: #8bc34a;
    border: 2px solid #8bc34a;
  }

  .btn-secondary:hover {
    background: #8bc34a;
    color: white;
  }

  /* Пустое состояние */
  .no-results {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }

  .no-results h3 {
    font-size: 1.5rem;
    margin-bottom: 10px;
    color: #333;
  }

  /* Лоадер */
  .catalog-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    transition: opacity 0.3s ease;
  }

  .catalog-loader.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .loader-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #8bc34a;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  .loader-text {
    color: #2c5530;
    font-size: 16px;
    font-weight: 600;
    margin: 0;
  }

  /* Плавное появление карточек */


  .project-card.visible {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
    transition: all 0.3s ease;
    /* Возвращаем исходные значения */
    height: auto;
    min-height: 500px;
    padding: initial;
    margin: initial;
  }

  .project-card.hidden {
    display: none !important;
  }

  .projects-grid.loading .project-card {
    opacity: 0.3;
    pointer-events: none;
  }

  .share-btn {
    background: #2c5530;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    height: 44px;
    transition: background 0.2s ease;
  }

  .share-btn:hover {
    background: #1a3319;
  }


  .link-btn {
    background: none;
    border: none;
    color: #2c5530;
    text-decoration: underline;
    cursor: pointer;
    font-size: inherit;
  }

  .link-btn:hover {
    color: #1a3319;
  }

  .share-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #2c5530;
    color: white;
    padding: 12px 20px;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(100%);
    }

    to {
      opacity: 1;
      transform: translateX(0);
    }
  }


  /* Адаптивность */
  @media (max-width: 768px) {
    .filters-container {
      grid-template-columns: 1fr;
    }

    .search-group {
      grid-column: span 1;
    }

    .projects-grid {
      grid-template-columns: 1fr;
    }

    .catalog-title {
      font-size: 2rem;
    }

    .project-actions {
      flex-direction: column;
    }
  }

  @media (max-width: 480px) {
    .filters-section {
      padding: 20px 15px;
    }

    .project-content {
      padding: 20px;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const filters = {
      category: document.getElementById('category-filter'),
      area: document.getElementById('area-filter'),
      material: document.getElementById('material-filter'),
      floors: document.getElementById('floors-filter'),
      price: document.getElementById('price-filter'),
      search: document.getElementById('search-filter'),
      sort: document.getElementById('sort-filter')
    };

    const resetBtn = document.getElementById('reset-filters');
    const projectsGrid = document.getElementById('projects-grid');
    const resultsCount = document.getElementById('results-count');
    const noResults = document.getElementById('no-results');
    const loader = document.getElementById('catalog-loader');

    let isLoading = false;
    let imagesLoaded = 0;
    let totalImages = 0;

    // === НОВЫЕ ФУНКЦИИ ДЛЯ РАБОТЫ С URL ===

    // Получаем значения фильтров из URL при загрузке страницы
    function restoreFiltersFromURL() {
      const params = new URLSearchParams(window.location.search);

      Object.keys(filters).forEach(key => {
        const value = params.get(key);
        if (value && filters[key]) {
          filters[key].value = value;
        }
      });
    }

    // Обновляем URL с текущими значениями фильтров
    function updateURL() {
      const params = new URLSearchParams();

      Object.keys(filters).forEach(key => {
        const value = filters[key].value.trim();
        if (value) {
          params.set(key, value);
        }
      });

      const newURL = params.toString()
        ? `${window.location.pathname}?${params.toString()}`
        : window.location.pathname;

      // Обновляем URL без перезагрузки страницы
      window.history.pushState({}, '', newURL);
    }

    // Обработчик кнопок "Назад/Вперед" браузера
    window.addEventListener('popstate', function () {
      restoreFiltersFromURL();
      filterProjects();
    });

    // === ОБНОВЛЕННЫЕ ФУНКЦИИ ===

    // Показать лоадер
    function showLoader(text = 'Загрузка проектов...') {
      if (isLoading) return;
      isLoading = true;
      loader.querySelector('.loader-text').textContent = text;
      loader.classList.remove('hidden');
      projectsGrid.classList.add('loading');
    }

    // Скрыть лоадер
    function hideLoader() {
      isLoading = false;
      loader.classList.add('hidden');
      projectsGrid.classList.remove('loading');

      // Анимация появления карточек (ИСПРАВЛЕНО)
      setTimeout(() => {
        // Используем класс visible вместо проверки style
        const visibleCards = document.querySelectorAll('.project-card.visible');
        visibleCards.forEach((card, index) => {
          setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          }, index * 50);
        });
      }, 100);
    }

    // Отложенная функция (debounce) для поиска
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Функция сортировки
    function sortProjects(projects) {
      const sortValue = filters.sort.value;
      if (!sortValue) return projects;

      return Array.from(projects).sort((a, b) => {
        switch (sortValue) {
          case 'price-asc':
            return (parseInt(a.dataset.price) || 0) - (parseInt(b.dataset.price) || 0);
          case 'price-desc':
            return (parseInt(b.dataset.price) || 0) - (parseInt(a.dataset.price) || 0);
          case 'area-asc':
            return (parseInt(a.dataset.area) || 0) - (parseInt(b.dataset.area) || 0);
          case 'area-desc':
            return (parseInt(b.dataset.area) || 0) - (parseInt(a.dataset.area) || 0);
          case 'title-asc':
            return a.dataset.title.localeCompare(b.dataset.title);
          case 'title-desc':
            return b.dataset.title.localeCompare(a.dataset.title);
          case 'date-desc':
            return (parseInt(b.dataset.date) || 0) - (parseInt(a.dataset.date) || 0);
          case 'date-asc':
            return (parseInt(a.dataset.date) || 0) - (parseInt(b.dataset.date) || 0);
          default:
            return 0;
        }
      });
    }

    // Обновленная функция фильтрации с URL
    function filterProjects() {
      showLoader('Применение фильтров...');

      // Убираем класс visible у всех карточек
      document.querySelectorAll('.project-card').forEach(card => {
        card.classList.remove('visible');
      });

      // Небольшая задержка для плавности
      setTimeout(() => {
        const allProjects = projectsGrid.querySelectorAll('.project-card');
        let visibleProjects = [];

        // Сначала фильтруем
        allProjects.forEach(project => {
          let visible = true;

          // Фильтр по категории (ОБНОВЛЕНО для множественных категорий)
          if (filters.category.value) {
            const projectCategories = project.dataset.category.split(',');
            if (!projectCategories.includes(filters.category.value)) {
              visible = false;
            }
          }

          // Фильтр по площади
          if (filters.area.value) {
            const area = parseInt(project.dataset.area) || 0;
            const [min, max] = filters.area.value.split('-').map(v => v === '+' ? Infinity : parseInt(v));
            if (area < min || area > max) {
              visible = false;
            }
          }

          // Фильтр по материалу
          if (filters.material.value) {
            const selectedMaterial = filters.material.value.toLowerCase();
            let materialFound = false;
            
            // Проверяем поле material из front matter
            if (project.dataset.material) {
              const materials = project.dataset.material.toLowerCase().split(',').map(m => m.trim());
              materialFound = materials.some(material => material.includes(selectedMaterial));
            }
            
            // Если поле material пустое, проверяем в тексте (fallback для старых проектов)
            if (!materialFound && !project.dataset.material) {
              const projectContent = project.textContent.toLowerCase();
              materialFound = projectContent.includes(selectedMaterial);
            }
            
            if (!materialFound) {
              visible = false;
            }
          }

          // Фильтр по этажам
          if (filters.floors.value && project.dataset.floors !== filters.floors.value) {
            visible = false;
          }

          // Фильтр по цене
          if (filters.price.value) {
            const price = parseInt(project.dataset.price) || 0;
            const [min, max] = filters.price.value.split('-').map(v => v === '+' ? Infinity : parseInt(v));
            if (price < min || price > max) {
              visible = false;
            }
          }

          // Поиск по названию
          if (filters.search.value && !project.dataset.title.includes(filters.search.value.toLowerCase())) {
            visible = false;
          }

          if (visible) {
            visibleProjects.push(project);
          }

          // ИСПРАВЛЕНИЕ: Используем классы вместо display
          if (visible) {
            project.classList.remove('hidden');
            project.classList.add('visible');
          } else {
            project.classList.remove('visible');
            project.classList.add('hidden');
          }
        });

        // Сортируем видимые проекты
        const sortedProjects = sortProjects(visibleProjects);

        // Применяем порядок через CSS order
        sortedProjects.forEach((project, index) => {
          project.style.order = index;
        });

        // Обновить счетчик
        resultsCount.textContent = visibleProjects.length;

        // Показать/скрыть сообщение "ничего не найдено"
        noResults.style.display = visibleProjects.length === 0 ? 'block' : 'none';
        projectsGrid.style.display = visibleProjects.length === 0 ? 'none' : 'grid';

        // Скрыть лоадер
        setTimeout(hideLoader, 300);
      }, 150);
    }
    // Функция фильтрации с обновлением URL
    function filterProjectsWithURL() {
      updateURL(); // Обновляем URL
      filterProjects(); // Применяем фильтры
    }

    // === ОБРАБОТЧИКИ СОБЫТИЙ ===

    // Обработчики событий с debounce для поиска и обновлением URL
    Object.values(filters).forEach(filter => {
      if (filter === filters.search) {
        // Для поиска используем debounce
        filter.addEventListener('input', debounce(filterProjectsWithURL, 300));
      } else {
        filter.addEventListener('change', filterProjectsWithURL);
      }
    });

    // Обновленная функция сброса фильтров
    resetBtn.addEventListener('click', function () {
      showLoader('Сброс фильтров...');
      setTimeout(() => {
        // Очищаем все фильтры
        Object.values(filters).forEach(filter => {
          filter.value = '';
        });

        // Очищаем URL
        window.history.pushState({}, '', window.location.pathname);

        // Применяем фильтры
        filterProjects();
      }, 100);
    });

    // === ОСТАЛЬНЫЕ ФУНКЦИИ (БЕЗ ИЗМЕНЕНИЙ) ===

    // Отслеживание загрузки изображений
    function initImageLoading() {
      const images = document.querySelectorAll('.project-card img');
      totalImages = images.length;
      imagesLoaded = 0;

      if (totalImages === 0) {
        hideLoader();
        return;
      }

      images.forEach(img => {
        if (img.complete) {
          imagesLoaded++;
        } else {
          img.addEventListener('load', () => {
            imagesLoaded++;
            if (imagesLoaded === totalImages) {
              hideLoader();
            }
          });

          img.addEventListener('error', () => {
            imagesLoaded++;
            if (imagesLoaded === totalImages) {
              hideLoader();
            }
          });
        }
      });

      // Если все изображения уже загружены
      if (imagesLoaded === totalImages) {
        hideLoader();
      }
    }

    // Обработчик кнопок "Узнать цену"
    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('callback-btn')) {
        e.preventDefault();

        // Получаем данные о проекте из data-атрибутов
        const projectData = {
          title: e.target.dataset.projectTitle,
          area: e.target.dataset.projectArea,
          price: e.target.dataset.projectPrice,
          category: e.target.dataset.projectCategory
        };

        // Открываем форму с данными проекта
        openCallbackModalWithProject(projectData);
      }
    });

    // Мобильные фильтры
    const mobileFiltersToggle = document.getElementById('mobile-filters-toggle');
    const filtersSection = document.querySelector('.filters-section');

    if (mobileFiltersToggle && filtersSection) {
      mobileFiltersToggle.addEventListener('click', function () {
        const isActive = filtersSection.classList.contains('active');

        if (isActive) {
          // Скрываем фильтры
          filtersSection.classList.remove('active');
          mobileFiltersToggle.classList.remove('active');
          mobileFiltersToggle.innerHTML = 'Показать фильтры';
        } else {
          // Показываем фильтры
          filtersSection.classList.add('active');
          mobileFiltersToggle.classList.add('active');
          mobileFiltersToggle.innerHTML = 'Скрыть фильтры';
        }
      });
    }

    // Автоматически скрываем фильтры при изменении размера экрана
    window.addEventListener('resize', function () {
      if (window.innerWidth > 768) {
        // На десктопе убираем классы активности
        filtersSection.classList.remove('active');
        mobileFiltersToggle.classList.remove('active');
      }
    });

    // === ИНИЦИАЛИЗАЦИЯ ===

    // Восстанавливаем фильтры из URL при загрузке
    restoreFiltersFromURL();

    // Инициализация при загрузке страницы
    showLoader('Загрузка каталога...');

    // Сначала показываем все карточки как видимые
    document.querySelectorAll('.project-card').forEach(card => {
      card.classList.add('visible');
    });

    setTimeout(() => {
      initImageLoading();

      // Применяем фильтры с учетом параметров из URL
      filterProjects();

      // Если изображения загрузились быстро, скрываем лоадер через секунду
      setTimeout(() => {
        if (isLoading) hideLoader();
      }, 1000);
    }, 100);

    // === ДОПОЛНИТЕЛЬНЫЕ УТИЛИТЫ ===

    // Функция для программного установки фильтра (может понадобиться для внешних ссылок)
    window.setFilter = function (filterName, value) {
      if (filters[filterName]) {
        filters[filterName].value = value;
        filterProjectsWithURL();
      }
    };

    // Функция для получения текущих фильтров
    window.getCurrentFilters = function () {
      const currentFilters = {};
      Object.keys(filters).forEach(key => {
        const value = filters[key].value.trim();
        if (value) {
          currentFilters[key] = value;
        }
      });
      return currentFilters;
    };

    // Функция для создания ссылки с фильтрами
    window.createFilterLink = function (additionalFilters = {}) {
      const currentFilters = window.getCurrentFilters();
      const allFilters = { ...currentFilters, ...additionalFilters };

      const params = new URLSearchParams();
      Object.entries(allFilters).forEach(([key, value]) => {
        if (value) {
          params.set(key, value);
        }
      });

      return params.toString()
        ? `${window.location.pathname}?${params.toString()}`
        : window.location.pathname;
    };
    // === ДОПОЛНИТЕЛЬНЫЕ ОБРАБОТЧИКИ ===

    // Кнопка поделиться фильтрами
    const shareBtn = document.getElementById('share-filters');
    if (shareBtn) {
      shareBtn.addEventListener('click', function () {
        if (navigator.share) {
          navigator.share({
            title: 'Каталог проектов с фильтрами',
            url: window.location.href
          }).catch(err => console.log('Ошибка при попытке поделиться:', err));
        } else {
          // Копируем ссылку в буфер обмена
          navigator.clipboard.writeText(window.location.href).then(() => {
            // Показываем уведомление
            showShareNotification('Ссылка скопирована в буфер обмена!');
          }).catch(() => {
            // Fallback для старых браузеров
            const textArea = document.createElement('textarea');
            textArea.value = window.location.href;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showShareNotification('Ссылка скопирована!');
          });
        }
      });
    }

    // Кнопка сброса из пустого состояния
    const resetFromEmpty = document.getElementById('reset-from-empty');
    if (resetFromEmpty) {
      resetFromEmpty.addEventListener('click', function () {
        // Очищаем все фильтры
        Object.values(filters).forEach(filter => {
          filter.value = '';
        });

        // Очищаем URL
        window.history.pushState({}, '', window.location.pathname);

        // Применяем фильтры
        filterProjects();
      });
    }

    // Функция показа уведомления
    function showShareNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'share-notification';
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }
  });
</script>
{{ end }}