<!-- Модальное окно для обратного звонка -->
<div class="callback-modal" id="callbackModal">
  <div class="callback-modal-overlay" onclick="closeCallbackModal()"></div>
  <div class="callback-modal-content">
    <div class="callback-modal-header">
      <h2>Заказать обратный звонок</h2>
      <button class="callback-modal-close" onclick="closeCallbackModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>
    </div>

    <div class="callback-modal-body">
      <form class="callback-form" id="callbackForm">
        <!-- Имя -->
        <div class="callback-form-group">
          <label for="callbackName" class="callback-form-label">Ваше имя *</label>
          <input type="text" id="callbackName" name="name" class="callback-form-input" placeholder="Введите ваше имя"
            required>
        </div>

        <!-- Телефон -->
        <div class="callback-form-group">
          <label for="callbackPhone" class="callback-form-label">Номер телефона *</label>
          <input type="tel" id="callbackPhone" name="phone" class="callback-form-input" placeholder="+7 (___) ___-__-__"
            required>
        </div>

        <!-- Время звонка -->
        <div class="callback-form-group">
          <label for="callbackTime" class="callback-form-label">Удобное время для звонка</label>
          <select id="callbackTime" name="callTime" class="callback-form-select">
            <option value="now">Сейчас</option>
            <option value="morning">Утром (9:00 - 12:00)</option>
            <option value="afternoon">Днем (12:00 - 17:00)</option>
            <option value="evening">Вечером (17:00 - 20:00)</option>
          </select>
        </div>

        <!-- Комментарий -->
        <div class="callback-form-group">
          <label for="callbackComment" class="callback-form-label">Комментарий</label>
          <textarea id="callbackComment" name="comment" class="callback-form-textarea"
            placeholder="Дополнительные пожелания или вопросы" rows="3"></textarea>
        </div>

        <!-- Согласие -->
        <div class="callback-form-group checkbox-group">
          <input type="checkbox" id="callbackPrivacy" name="privacy" required>
          <label for="callbackPrivacy" class="callback-checkbox-label">
            Я согласен на обработку <a href="/privacy/" target="_blank">персональных данных</a> *
          </label>
        </div>

        <!-- Кнопка отправки -->
        <button type="submit" class="callback-form-submit">
          <span class="callback-btn-text">Заказать звонок</span>
          <span class="callback-btn-loader" style="display: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" opacity="0.3" />
              <path d="M12 2v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
          </span>
        </button>
      </form>

      <!-- Успешная отправка -->
      <div class="callback-success" id="callbackSuccess" style="display: none;">
        <div class="callback-success-icon">
          <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="#8bc34a" stroke-width="2" />
            <path d="M9 12l2 2 4-4" stroke="#8bc34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </div>
        <h3>Спасибо за заявку!</h3>
        <p>Мы свяжемся с вами в ближайшее время</p>
        <button class="callback-success-btn" onclick="closeCallbackModal()">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Модальное окно */
  .callback-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    font-family: Arial, sans-serif;
  }

  .callback-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  }

  .callback-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    cursor: pointer;
  }

  .callback-modal-content {
    position: relative;
    background: white;
    border-radius: 15px;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideInUp 0.3s ease;
    margin: 20px;
  }

  /* Заголовок */
  .callback-modal-header {
    padding: 25px 30px 20px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .callback-modal-header h2 {
    margin: 0;
    color: #2c5530;
    font-size: 24px;
    font-weight: 700;
  }

  .callback-modal-close {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .callback-modal-close:hover {
    background: #f0f0f0;
    color: #2c5530;
    transform: rotate(90deg);
  }

  /* Тело модального окна */
  .callback-modal-body {
    padding: 30px;
  }

  /* Форма */
  .callback-form-group {
    margin-bottom: 20px;
  }

  .callback-form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2c5530;
    font-size: 14px;
  }

  .callback-form-input,
  .callback-form-select,
  .callback-form-textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.3s ease;
    background: white;
    box-sizing: border-box;
  }

  .callback-form-input:focus,
  .callback-form-select:focus,
  .callback-form-textarea:focus {
    outline: none;
    border-color: #8bc34a;
    box-shadow: 0 0 0 3px rgba(139, 195, 74, 0.1);
  }

  .callback-form-textarea {
    resize: vertical;
    min-height: 80px;
  }

  .callback-form-select {
    cursor: pointer;
    background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    appearance: none;
  }

  /* Чекбокс */
  .checkbox-group {
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .checkbox-group input[type="checkbox"] {
    width: auto;
    margin: 0;
    margin-top: 2px;
    flex-shrink: 0;
  }

  .callback-checkbox-label {
    font-size: 14px;
    line-height: 1.4;
    color: #666;
    margin: 0;
    cursor: pointer;
  }

  .callback-checkbox-label a {
    color: #8bc34a;
    text-decoration: none;
  }

  .callback-checkbox-label a:hover {
    text-decoration: underline;
  }

  /* Кнопка отправки */
  .callback-form-submit {
    width: 100%;
    background: linear-gradient(135deg, #8bc34a, #4a7c59);
    color: white;
    border: none;
    padding: 15px 20px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    margin-top: 10px;
  }

  .callback-form-submit:hover:not(:disabled) {
    background: linear-gradient(135deg, #4a7c59, #2c5530);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(139, 195, 74, 0.3);
  }

  .callback-form-submit:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  .callback-btn-loader {
    animation: spin 1s linear infinite;
  }

  /* Сообщение об успешной отправке */
  .callback-success {
    text-align: center;
    padding: 20px;
  }

  .callback-success-icon {
    margin-bottom: 20px;
  }

  .callback-success h3 {
    color: #2c5530;
    margin-bottom: 10px;
    font-size: 22px;
  }

  .callback-success p {
    color: #666;
    margin-bottom: 25px;
    font-size: 16px;
  }

  .callback-success-btn {
    background: linear-gradient(135deg, #8bc34a, #4a7c59);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .callback-success-btn:hover {
    background: linear-gradient(135deg, #4a7c59, #2c5530);
    transform: translateY(-2px);
  }

  /* Анимации */
  @keyframes fadeIn {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }

    to {
      transform: rotate(360deg);
    }
  }

  /* Мобильная адаптация */
  @media (max-width: 768px) {
    .callback-modal-content {
      margin: 10px;
      max-height: 95vh;
    }

    .callback-modal-header {
      padding: 20px 20px 15px;
    }

    .callback-modal-header h2 {
      font-size: 20px;
    }

    .callback-modal-body {
      padding: 20px;
    }

    .callback-form-input,
    .callback-form-select,
    .callback-form-textarea {
      font-size: 16px;
      /* Предотвращает zoom на iOS */
    }
  }

  @media (max-width: 480px) {
    .callback-modal-content {
      margin: 5px;
    }

    .callback-modal-header {
      padding: 15px 15px 10px;
    }

    .callback-modal-body {
      padding: 15px;
    }
  }

  /* Валидация */
  .callback-form-input:invalid,
  .callback-form-textarea:invalid {
    border-color: #dc3545;
  }

  .callback-form-input:valid,
  .callback-form-textarea:valid {
    border-color: #28a745;
  }

  /* Состояние загрузки формы */
  .callback-form.loading {
    opacity: 0.7;
    pointer-events: none;
  }
</style>

<script>
  // Функции управления модальным окном
  function openCallbackModal() {
    const modal = document.getElementById('callbackModal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Фокус на первое поле
    setTimeout(() => {
      document.getElementById('callbackName').focus();
    }, 300);
  }

  function closeCallbackModal() {
    const modal = document.getElementById('callbackModal');
    modal.classList.remove('active');
    document.body.style.overflow = '';

    // Сброс формы
    resetCallbackForm();
  }

  function resetCallbackForm() {
    const form = document.getElementById('callbackForm');
    const success = document.getElementById('callbackSuccess');

    form.style.display = 'block';
    success.style.display = 'none';
    form.reset();

    // Сброс состояния кнопки
    const submitBtn = form.querySelector('.callback-form-submit');
    submitBtn.disabled = false;
    submitBtn.querySelector('.callback-btn-text').style.display = 'inline';
    submitBtn.querySelector('.callback-btn-loader').style.display = 'none';
  }

  // Обновляем функцию в виджете
  function showCallbackForm() {
    openCallbackModal();

    // Закрываем виджет
    const widget = document.getElementById('contactWidget');
    if (widget) {
      widget.classList.remove('active');
    }
  }

  // Маска для телефона
  function initPhoneMask() {
    const phoneInput = document.getElementById('callbackPhone');
    if (!phoneInput) return;

    phoneInput.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');

      if (value.length > 0) {
        if (value[0] === '8') {
          value = '7' + value.slice(1);
        }
        if (value[0] === '7') {
          value = value.replace(/^7(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/, function (match, p1, p2, p3, p4) {
            let result = '+7';
            if (p1) result += ' (' + p1;
            if (p1 && p1.length === 3) result += ')';
            if (p2) result += ' ' + p2;
            if (p3) result += '-' + p3;
            if (p4) result += '-' + p4;
            return result;
          });
        }
      }

      e.target.value = value;
    });

    // Placeholder исчезает при фокусе
    phoneInput.addEventListener('focus', function (e) {
      if (e.target.value === '') {
        e.target.value = '+7 (';
      }
    });

    phoneInput.addEventListener('blur', function (e) {
      if (e.target.value === '+7 (') {
        e.target.value = '';
      }
    });
  }

  // Обработка формы
  function initCallbackForm() {
    const form = document.getElementById('callbackForm');
    if (!form) return;

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      // Валидация
      if (!validateCallbackForm()) {
        return;
      }

      // Состояние загрузки
      const submitBtn = form.querySelector('.callback-form-submit');
      submitBtn.disabled = true;
      submitBtn.querySelector('.callback-btn-text').style.display = 'none';
      submitBtn.querySelector('.callback-btn-loader').style.display = 'inline';

      form.classList.add('loading');

      // Получаем данные формы
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      // Отправка данных (замените на ваш API)
      submitCallbackForm(data)
        .then(() => {
          // Показываем сообщение об успехе
          form.style.display = 'none';
          document.getElementById('callbackSuccess').style.display = 'block';
        })
        .catch((error) => {
          console.error('Ошибка отправки:', error);
          alert('Произошла ошибка при отправке заявки. Попробуйте позже.');
        })
        .finally(() => {
          form.classList.remove('loading');
          submitBtn.disabled = false;
          submitBtn.querySelector('.callback-btn-text').style.display = 'inline';
          submitBtn.querySelector('.callback-btn-loader').style.display = 'none';
        });
    });
  }

  // Валидация формы
  function validateCallbackForm() {
    const name = document.getElementById('callbackName').value.trim();
    const phone = document.getElementById('callbackPhone').value.trim();
    const privacy = document.getElementById('callbackPrivacy').checked;

    if (!name || name.length < 2) {
      alert('Введите корректное имя');
      return false;
    }

    if (!phone || phone.length < 10) {
      alert('Введите корректный номер телефона');
      return false;
    }

    if (!privacy) {
      alert('Необходимо согласие на обработку персональных данных');
      return false;
    }

    return true;
  }

  // Отправка данных (замените на ваш API)
  async function submitCallbackForm(data) {
    // Имитация отправки
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        console.log('Данные формы обратного звонка:', data);

        // Здесь должна быть реальная отправка на сервер
        // fetch('/api/callback', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify(data)
        // })

        resolve();
      }, 2000);
    });
  }

  // Закрытие по Escape
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('callbackModal');
      if (modal && modal.classList.contains('active')) {
        closeCallbackModal();
      }
    }
  });

  // Инициализация при загрузке
  document.addEventListener('DOMContentLoaded', function () {
    initPhoneMask();
    initCallbackForm();
  });
</script>